<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/css/style.css">
    <link rel="icon" href="../static/icons/rinon.png">
    <title>Renal Spectra</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="../static/js/script.js" ></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
            <div class="navbar-brand">
                <a href="{{ url_for('home_admin') }}" class='logoHeader'>
                    <img class='logo' alt="Renal Spectra Logo" src='../static/icons/rinon.png' />
                    <span>Renal Spectra</span>
                </a>
            </div>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarScroll" aria-controls="navbarScroll" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarScroll">
                <ul class="navbar-nav my-lg-0 navbar-nav" style="--bs-scroll-height: 100px;">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Pacientes
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('add_patient') }}">Añadir paciente</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('search_patient') }}">Buscar paciente</a></li>
                        </ul>
                    </li>
                </ul>
                <div class="button red-btn" onClick="logOut()">
                    <img class="icon" src="../static/icons/User.png" alt="">
                    Cerrar Sesión
                </div>
                </a>
            </div>
        </div>
    </nav>
    <main>
        <section class="analytics-patient">
            <h1>Análisis:</h1>
            <div class="info-sup-container">
                <div class='infoPatientContainer'>
                    <form id="form-analytics-patient" class="row g-3">
                        <div class="col-md-12">
                            <label for="inputNameLastName" class="form-label">Paciente:</label>
                            <input type="text" readonly class="form-control-plaintext" id="floating-inputNameLastName" placeholder="First name">
                        </div>
                        <div class="col-md-12">
                            <h4>Última lectura filtrado glomerular:</h4>
                        </div>
                        <div class="col-md-12">
                            <label for="inputEstadio" class="form-label">Estadio:</label>
                            <input type="text" readonly class="form-control-plaintext" id="floating-inputEstadio" placeholder="Estadio">
                        </div>
                        <div class="col-md-12">
                            <label for="inputDescripcion" class="form-label">Descripción:</label>
                            <input type="text" readonly class="form-control-plaintext" id="floating-inputDescription" placeholder="Descripción">
                        </div>
                        <div class="col-md-12">
                            <label for="inputFiltradoGlomerular" class="form-label">Valor:</label>
                            <input type="text" readonly class="form-control-plaintext" id="floating-inputFiltradoGlomerular" placeholder="Valor">
                        </div>
                        <div class="col-md-12">
                            <h4>Última lectura Creatinina:</h4>
                        </div>
                        <div class="col-md-12">
                            <label for="inputCreatinina" class="form-label">Valor:</label>
                            <input type="text" readonly class="form-control-plaintext" id="floating-inputCreatinina" placeholder="Valor">
                        </div>
                    </form>
                </div>
                <div class="container-rinon">
                    <div class="rinon">
                        <div class="top-element"></div>
                        <div class="bottom-element"></div>
                        <div class="center-element1"></div>
                        <div class="center-element2"></div>
                        <!-- <div class="barra"></div> -->
                        <h1>50%</h1>
                    </div>
                </div>
            </div>
            <div class="buttonsContainer">
                <a href="{{ url_for('modify_patient') }}">
                    <div class="button">
                        <img class="icon" src="../static/icons/ArrowRight.png" alt="">
                        Actualizar Análisis
                    </div>
                </a>
                <a href="./analytics.html">
                    <div class="button">
                        <img class="icon" src="../static/icons/TrendUp.png" alt="">
                        Reporte
                    </div>
                </a>
            </div>
        </section>
    </main>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const patientData = JSON.parse(localStorage.getItem('patientData'));

            if (patientData && patientData.ci) {
                fetchMetrics(patientData.ci);
            } else {
                alert('No se encontró la información del paciente.');
            }

            if (patientData) {
                document.getElementById('floating-inputNameLastName').value = patientData.name + ' ' + patientData.lastname;
                

                // Elimina los datos del localStorage si ya no son necesarios
                // localStorage.removeItem('patientData');
            }
        });

        // Función que se ejecuta al cargar la página
        async function fetchMetrics(ci) {
            try {
                const response = await fetch(`/metrics/${ci}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ type: 'actualizar' })
                });

                if (response.ok) {
                    const metrics = await response.json();
                    console.log('Métricas recibidas:', metrics);
                    // Aquí podrías también actualizar el DOM con los datos de metrics si lo necesitas
                    // displayMetrics(metrics);
                } else {
                    const errorData = await response.json();
                    alert(`Error al obtener métricas: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Ocurrió un error al cargar las métricas. Inténtalo nuevamente más tarde.');
            }
        }


        // Función para mostrar las métricas en el DOM
        function displayMetrics(metrics) {
            // Ejemplo de cómo podrías actualizar el contenido de tu HTML con los datos de las métricas
            document.getElementById('metricName').innerText = metrics.name; // Nombre del paciente
            document.getElementById('metricValue').innerText = metrics.someMetricField; // Otros datos relevantes
            // Agrega más campos según los datos que obtengas de la base de datos
        }


    </script>
</body>
</html>